apiVersion: spark.stackable.tech/v1alpha1
kind: SparkApplication
metadata:
  name: steam-charts-app
  namespace: default
spec:
  sparkImage:
    productVersion: "3.5.6"
    pullPolicy: "IfNotPresent"
  mode: cluster
  mainApplicationFile: "local:///opt/spark/work-dir/process_charts.py"
  
  deps:
    packages:
      - org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.6
      - org.mongodb.spark:mongo-spark-connector_2.12:10.5.0
    excludePackages:
      - org.apache.hadoop:hadoop-client-runtime
      - org.apache.hadoop:hadoop-client-api

  sparkConf:
    spark.app.name: "SteamCharts"
    # Memory optimization for local dev
    spark.driver.memory: "512m"
    spark.executor.memory: "512m"
    spark.executor.instances: "1"
    # Enable Spark UI for monitoring
    spark.ui.enabled: "true"
    spark.ui.port: "4040" 
    spark.hadoop.fs.defaultFS: "hdfs://simple-hdfs"
    spark.hadoop.dfs.nameservices: "simple-hdfs"
    spark.hadoop.dfs.ha.namenodes.simple-hdfs: "nn0,nn1"
    spark.hadoop.dfs.namenode.rpc-address.simple-hdfs.nn0: "simple-hdfs-namenode-default-0.simple-hdfs-namenode-default.default.svc.cluster.local:8020"
    spark.hadoop.dfs.namenode.rpc-address.simple-hdfs.nn1: "simple-hdfs-namenode-default-1.simple-hdfs-namenode-default.default.svc.cluster.local:8020"
    spark.hadoop.dfs.client.failover.proxy.provider.simple-hdfs: "org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider"
    spark.mongodb.write.connection.uri: "mongodb://mongodb.default.svc.cluster.local:27017/game_analytics.steam_charts"
  env:
    - name: KAFKA_BOOTSTRAP_SERVERS
      value: "simple-kafka-broker-default-bootstrap.default.svc.cluster.local:9093"
    - name: KAFKA_SECURITY_PROTOCOL
      value: "SSL"
    - name: KAFKA_SSL_TRUSTSTORE
      value: "/stackable/tls/truststore.p12"
  volumes:
    - name: analytics-scripts
      configMap:
        name: kafka-spark-configmap
    - name: tls
      ephemeral:
        volumeClaimTemplate:
          metadata:
            annotations:
              secrets.stackable.tech/class: tls
              secrets.stackable.tech/scope: pod
          spec:
            storageClassName: secrets.stackable.tech
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: "1"
    - name: truststore-vol
      emptyDir: {}
  driver:
    config:
      volumeMounts:
        - name: analytics-scripts 
          mountPath: /opt/spark/work-dir
        - name: tls
          mountPath: /stackable/tls
        - name: truststore-vol
          mountPath: /truststore
    podOverrides:
      spec:
        initContainers:
          - name: create-truststore
            image: eclipse-temurin:17-jdk
            command:
              - sh
              - -c
              - |
                echo "Creating truststore from CA certificate..."
                keytool -import -trustcacerts -noprompt \
                  -alias ca -file /stackable/tls/ca.crt \
                  -keystore /truststore/truststore.p12 \
                  -storetype PKCS12 -storepass changeit
                echo "Truststore created at /truststore/truststore.p12"
                ls -la /truststore/
            volumeMounts:
              - name: tls
                mountPath: /stackable/tls
              - name: truststore-vol
                mountPath: /truststore
  executor:
    config:
      volumeMounts:
        - name: analytics-scripts
          mountPath: /opt/spark/work-dir
        - name: tls
          mountPath: /stackable/tls
        - name: truststore-vol
          mountPath: /truststore
    podOverrides:
      spec:
        initContainers:
          - name: create-truststore
            image: eclipse-temurin:17-jdk
            command:
              - sh
              - -c
              - |
                echo "Creating truststore from CA certificate..."
                keytool -import -trustcacerts -noprompt \
                  -alias ca -file /stackable/tls/ca.crt \
                  -keystore /truststore/truststore.p12 \
                  -storetype PKCS12 -storepass changeit
                echo "Truststore created at /truststore/truststore.p12"
            volumeMounts:
              - name: tls
                mountPath: /stackable/tls
              - name: truststore-vol
                mountPath: /truststore